"use strict";var Consts={GRID:20,HEIGHT:33,NODE:3,PALETTE:3},Simulation={nodes:[],links:[],addNode:function(t,n,e,o){for(var r=this.nodes.length,i=[],a=[],d=0;d<t;d++)i[d]={nodeId:r,portId:d,inPort:!0,linkId:null};for(var s=0;s<n;s++)a[s]={nodeId:r,portId:s,inPort:!1,linkId:null};return this.nodes[r]={nodeId:r,state:null,inPorts:i,outPorts:a,logic:e,elem:o},r},getNode:function(t){return this.nodes[t]},removeNode:function(t){var n=this.nodes[t];$.each(n.inPorts,function(t,n){null!==n.linkId&&this.removeLink(n.linkId)}.bind(this)),$.each(n.outPorts,function(t,n){null!==n.linkId&&this.removeLink(n.linkId)}.bind(this)),delete this.nodes[t],$(n.elem).remove()},canLink:function(t,n,e,o){var r=[e],i=[],a=[],d=this.nodes[t].outPorts[n];null!==d&&a.push(d);var s=this.nodes[e].inPorts[o];for(null!==s&&a.push(s);r.length>0;){var u=this.nodes[r.pop()];if(u.nodeId===t)return!1;$.each(u.outPorts,function(t,n){if(null!==n.linkId&&a.indexOf(n.linkId)===-1){var e=this.links[n.linkId],o=this.nodes[e.inNodeId];i.indexOf(o.nodeId)===-1&&r.push(o.nodeId)}}.bind(this)),i.push(u.nodeId)}return!0},addLink:function(t,n,e,o,r){var i=this.links.length;this.links[i]={linkId:i,state:null,outNodeId:t,outPortId:n,inNodeId:e,inPortId:o,elem:r};var a=this.nodes[t].outPorts[n];null!==a.linkId&&this.removeLink(a.linkId),a.linkId=i;var d=this.nodes[e].inPorts[o];return null!==d.linkId&&this.removeLink(d.linkId),d.linkId=i,i},getLink:function(t){return this.links[t]},removeLink:function(t){var n=this.links[t];this.nodes[n.outNodeId].outPorts[n.outPortId].linkId=null,this.nodes[n.inNodeId].inPorts[n.inPortId].linkId=null,delete this.links[t];var e=$(n.elem).data("linkInfo");e.inPortElem.removeData("linkId"),e.outPortElem.removeData("linkId"),$(n.elem).remove()},getNodeState:function(t){return this.nodes[t].state},getLinkState:function(t){return this.links[t].state},update:function(){var t=this,n=[],e=[];$.each(this.nodes,function(t,n){"undefined"!=typeof n&&(n.state=null)}.bind(this)),$.each(this.links,function(t,n){"undefined"!=typeof n&&(n.state=null)}.bind(this)),$.each(this.nodes,function(t,e){"undefined"!=typeof e&&0===e.inPorts.length&&n.push(e.nodeId)}.bind(this));for(var o=function(){var o=t.nodes[n.pop()],r=[];$.each(o.inPorts,function(t,n){r.push(this.links[n.linkId].state)}.bind(t)),o.state=o.logic(r),$.each(o.outPorts,function(t,r){if(null!==r.linkId){var i=this.links[r.linkId];i.state=o.state;var a=this.nodes[i.inNodeId],d=!0;$.each(a.inPorts,function(t,n){if(null===n.linkId)return d=!1,!1;var e=this.links[n.linkId];return null===e.state?(d=!1,!1):void 0}.bind(this)),d&&e.indexOf(a.nodeId)===-1&&n.push(a.nodeId)}}.bind(t)),e.push(o.nodeId)};n.length>0;)o()}},grid=$("#grid"),nodes=$("#nodes"),links=$("#links"),temp=$("#temp"),tempLine=$("#temp-line"),tempLineBorder=$("#temp-line-border"),map=[[]],toGrid=function(t){var n=grid.offset();return{x:Math.round((t.x-n.left)/Consts.GRID),y:Math.round((t.y-n.top)/Consts.GRID)}},toPage=function(t){var n=grid.offset();return{x:n.left+t.x*Consts.GRID,y:n.top+t.y*Consts.GRID}},isFreeSpace=function(t){var n=t.x,e=t.y;if(n<1||e<1)return!1;if(n>map.length-Consts.NODE-1)return!1;if(e>Consts.HEIGHT-Consts.NODE-1)return!1;for(var o=-1;o<Consts.NODE+1;o++)for(var r=-1;r<Consts.NODE+1;r++)if(map[n+o][e+r])return!1;return!0},findFreeSpace=function(t){var n=t.x,e=t.y,o=Math.max(map.length,Consts.HEIGHT);if(isFreeSpace({x:n,y:e}))return{x:n,y:e};for(var r=1;r<o;r++){if(isFreeSpace({x:n-r,y:e}))return{x:n-r,y:e};if(isFreeSpace({x:n+r,y:e}))return{x:n+r,y:e};if(isFreeSpace({x:n,y:e-r}))return{x:n,y:e-r};if(isFreeSpace({x:n,y:e+r}))return{x:n,y:e+r};for(var i=1;i<=r-1;i++){if(isFreeSpace({x:n-i,y:e-r}))return{x:n-i,y:e-r};if(isFreeSpace({x:n-i,y:e+r}))return{x:n-i,y:e+r};if(isFreeSpace({x:n+i,y:e-r}))return{x:n+i,y:e-r};if(isFreeSpace({x:n+i,y:e+r}))return{x:n+i,y:e+r};if(isFreeSpace({x:n-r,y:e-i}))return{x:n-r,y:e-i};if(isFreeSpace({x:n+r,y:e-i}))return{x:n+r,y:e-i};if(isFreeSpace({x:n-r,y:e+i}))return{x:n-r,y:e+i};if(isFreeSpace({x:n+r,y:e+i}))return{x:n+r,y:e+i}}if(isFreeSpace({x:n-r,y:e-r}))return{x:n-r,y:e-r};if(isFreeSpace({x:n-r,y:e+r}))return{x:n-r,y:e+r};if(isFreeSpace({x:n+r,y:e-r}))return{x:n+r,y:e-r};if(isFreeSpace({x:n+r,y:e+r}))return{x:n+r,y:e+r}}return null},resizeHandler=function(){var t=this,n=map.length,e=Math.floor(grid.parent().width()/Consts.GRID);e!==n&&!function(){map=new Array(e);for(var n=0;n<e;n++){map[n]=new Array(Consts.HEIGHT);for(var o=0;o<Consts.HEIGHT;o++)map[n][o]=!1}var r=[];$.each(nodes.children(),function(t,n){var e=$(n),o=e.data("nodeInfo"),i=findFreeSpace({x:o.gridX,y:o.gridY});if(null===i)return void r.push(n);o.gridX=i.x,o.gridY=i.y,e.data("nodeInfo",o);var a=toPage(i);e.offset({left:a.x,top:a.y});for(var d=0;d<Consts.NODE;d++)for(var s=0;s<Consts.NODE;s++)map[i.x+d][i.y+s]=!0}.bind(t)),$.each(r,function(t,n){removeNodeElem(n)}.bind(t));var i=e*Consts.GRID+1;grid.width(i),$(".link").width(i),temp.width(i),temp.offset(grid.offset()),redrawLinks()}()},initPalette=function(t,n){for(var e=$(t),o=$("#node-template").children().first(),r=null,i=0;i<n.length;i++){var a=n[i],d=$(document.createElement("td")),s=o.clone();switch(i%Consts.PALETTE===0&&(null!==r&&r.appendTo(e),r=$(document.createElement("tr"))),s.data("def",a),a.numInPorts){case 0:s.find(".node-port-in-1").hide(),s.find(".node-port-in-2").hide(),s.find(".node-port-in-3").hide();break;case 1:s.find(".node-port-in-1").hide(),s.find(".node-port-in-2").first().data("inPortId",0),s.find(".node-port-in-3").hide();break;case 2:s.find(".node-port-in-1").first().data("inPortId",0),s.find(".node-port-in-2").hide(),s.find(".node-port-in-3").first().data("inPortId",1);break;case 3:s.find(".node-port-in-1").first().data("inPortId",0),s.find(".node-port-in-2").first().data("inPortId",1),s.find(".node-port-in-3").first().data("inPortId",2)}switch(a.numOutPorts){case 0:s.find(".node-port-out-1").hide(),s.find(".node-port-out-2").hide(),s.find(".node-port-out-3").hide();break;case 1:s.find(".node-port-out-1").hide(),s.find(".node-port-out-2").first().data("outPortId",0),s.find(".node-port-out-3").hide();break;case 2:s.find(".node-port-out-1").first().data("outPortId",0),s.find(".node-port-out-2").hide(),s.find(".node-port-out-3").first().data("outPortId",1);break;case 3:s.find(".node-port-out-1").first().data("outPortId",0),s.find(".node-port-out-2").first().data("outPortId",1),s.find(".node-port-out-3").first().data("outPortId",2)}$(a.icon).children().clone(!0).appendTo(s.find(".node-grabber")),s.appendTo(d),d.appendTo(r)}if(null!==r){for(var u=0;u<Consts.PALETTE-n.length%Consts.PALETTE;u++)$(document.createElement("td")).appendTo(r);r.appendTo(e)}},removeNodeElem=function(t){var n=$(t).data("nodeInfo");"undefined"==typeof n?t.remove():Simulation.removeNode(n.nodeId)},getPortCoords=function(t){var n=t.parent(),e=n.data("def"),o=n.data("nodeInfo"),r={x:o.gridX,y:o.gridY};if(t.hasClass("node-port-in")){var i=t.data("inPortId");switch(i){case 0:r.y+=1==e.numInPorts?1:0;break;case 1:r.y+=2==e.numInPorts?2:1;break;case 2:r.y+=2}}else{var a=t.data("outPortId");switch(r.x+=2,a){case 0:r.y+=1==e.numOutPorts?1:0;break;case 1:r.y+=2==e.numOutPorts?2:1;break;case 2:r.y+=2}}return r},isOpen=function(t){return!(t.x<0||t.y<0)&&(!(t.x>map.length-1)&&(!(t.y>map[t.x].length-1)&&!map[t.x][t.y]))},toCoordsString=function(t){return String(t.x)+","+String(t.y)},equalCoords=function(t,n){return t.x===n.x&&t.y===n.y},addToPath=function(t,n,e,o,r,i){if(isOpen(t)){var a=toCoordsString(t),d=r+(i?1.5:1),s=n[a];"undefined"==typeof s?(s={coords:t,path:[t].concat(o),length:d},n[a]=s,e.push(s)):d<s.length&&(s.path=[t].concat(o),s.length=d)}},findPath=function(t,n){var e=function(t,n){return t.length-n.length},o={x:t.x-1,y:t.y},r=toCoordsString(o),i={x:n.x+1,y:n.y},a={},d=[],s={coords:o,path:[o],length:1};for(a[r]=s,d.push(s);Object.keys(d).length>0;){d.sort(e);var u=d.shift();if(equalCoords(u.coords,i))return[n].concat(u.path).concat([t]);addToPath({x:u.coords.x-1,y:u.coords.y},a,d,u.path,u.length,!1),addToPath({x:u.coords.x+1,y:u.coords.y},a,d,u.path,u.length,!1),addToPath({x:u.coords.x,y:u.coords.y-1},a,d,u.path,u.length,!1),addToPath({x:u.coords.x,y:u.coords.y+1},a,d,u.path,u.length,!1),addToPath({x:u.coords.x-1,y:u.coords.y-1},a,d,u.path,u.length,!0),addToPath({x:u.coords.x-1,y:u.coords.y+1},a,d,u.path,u.length,!0),addToPath({x:u.coords.x+1,y:u.coords.y-1},a,d,u.path,u.length,!0),addToPath({x:u.coords.x+1,y:u.coords.y+1},a,d,u.path,u.length,!0)}return null},toPoints=function(t){var n="";return $.each(t,function(t,e){var o=e.x*Consts.GRID+Consts.GRID/2,r=e.y*Consts.GRID+Consts.GRID/2;n+=toCoordsString({x:o,y:r})+" "}.bind(this)),n.slice(0,-1)},addLinkElem=function(t,n){var e=t.data("inPortId"),o=t.parent().data("nodeInfo").nodeId,r=n.data("outPortId"),i=n.parent().data("nodeInfo").nodeId;if(Simulation.canLink(i,r,o,e)){var a=t.data("linkId");"undefined"!=typeof a&&Simulation.removeLink(a);var d=n.data("linkId");"undefined"!=typeof d&&Simulation.removeLink(d);var s=getPortCoords(t),u=getPortCoords(n),l=findPath(s,u),f=$("#link-template").children().first().clone();f.children().first().attr("points",toPoints(l)),$(f.children()[1]).attr("points",toPoints(l)),f.appendTo(links),f.offset(grid.offset());var c=Simulation.addLink(i,r,o,e,f);f.data("linkInfo",{linkId:c,inPortElem:t,outPortElem:n}),t.data("linkId",c),n.data("linkId",c)}},redrawLinks=function(){$.each(links.children(),function(t,n){n=$(n);var e=n.data("linkInfo"),o=findPath(getPortCoords(e.inPortElem),getPortCoords(e.outPortElem));n.children().first().attr("points",toPoints(o)),$(n.children()[1]).attr("points",toPoints(o))}.bind(this))},updateState=function(){Simulation.update(),$.each(nodes.children(),function(t,n){var e=$(n),o=Simulation.getNodeState(e.data("nodeInfo").nodeId);null===o?(e.removeClass("node-active"),e.removeClass("node-inactive")):o?(e.addClass("node-active"),e.removeClass("node-inactive")):(e.removeClass("node-active"),e.addClass("node-inactive"))}.bind(this)),$.each(links.children(),function(t,n){var e=$(n),o=Simulation.getLinkState(e.data("linkInfo").linkId);null===o?(e.removeClass("link-active"),e.removeClass("link-inactive")):o?(e.addClass("link-active"),e.removeClass("link-inactive")):(e.removeClass("link-active"),e.addClass("link-inactive")),e.offset(grid.offset())}.bind(this))},positionTempLine=function(t,n,e){var o=grid.offset(),r=toPage(getPortCoords($(t)));tempLine.attr("x1",r.x+Consts.GRID/2-o.left),tempLine.attr("y1",r.y+Consts.GRID/2-o.top),tempLine.attr("x2",n-o.left),tempLine.attr("y2",e-o.top),tempLineBorder.attr("x1",r.x+Consts.GRID/2-o.left),tempLineBorder.attr("y1",r.y+Consts.GRID/2-o.top),tempLineBorder.attr("x2",n-o.left),tempLineBorder.attr("y2",e-o.top),temp.offset(grid.offset())};interact(".node-grabber").draggable({manualStart:!0,snap:{targets:[function(t,n){var e=toPage(toGrid({x:t-Consts.NODE/2*Consts.GRID,y:n-Consts.NODE/2*Consts.GRID}));return e.x+=Consts.NODE/2*Consts.GRID,e.y+=Consts.NODE/2*Consts.GRID,e}]},onmove:function(t){var n=$(t.target).parent();n.offset({left:t.pageX-Consts.NODE/2*Consts.GRID,top:t.pageY-Consts.NODE/2*Consts.GRID})},onstart:function(t){var n=$(t.target).parent(),e=n.data("nodeInfo");if("undefined"!=typeof e)for(var o=0;o<Consts.NODE;o++)for(var r=0;r<Consts.NODE;r++)map[e.gridX+o][e.gridY+r]=!1;n.offset({left:t.pageX-Consts.NODE/2*Consts.GRID,top:t.pageY-Consts.NODE/2*Consts.GRID})},onend:function(t){var n=$(t.target).parent(),e=toGrid({x:t.pageX-Consts.NODE/2*Consts.GRID,y:t.pageY-Consts.NODE/2*Consts.GRID}),o=e.x,r=e.y;if(o<-Consts.NODE||r<-Consts.NODE||o>map.length+Consts.NODE||r>Consts.HEIGHT+Consts.NODE)return removeNodeElem(n),void updateState();var i=findFreeSpace({x:o,y:r});if(null===i)return removeNodeElem(n),void updateState();o=i.x,r=i.y;var a=toPage(i);n.offset({left:a.x,top:a.y});var d=n.data("nodeInfo");if("undefined"==typeof d){var s=n.data("def"),u=Simulation.addNode(s.numInPorts,s.numOutPorts,s.logic,n);d={nodeId:u}}d.gridX=o,d.gridY=r,n.data("nodeInfo",d);for(var l=0;l<Consts.NODE;l++)for(var f=0;f<Consts.NODE;f++)map[o+l][r+f]=!0;redrawLinks(),updateState()}}).on("move",function(t){var n=t.interaction;if(n.pointerIsDown&&!n.interacting()){var e=$(t.currentTarget).parent();if(e.hasClass("node-palette")){var o=e.clone(!0);o.removeClass("node-palette"),o.appendTo("#nodes"),o.offset($(t.currentTarget).parent().offset()),e=o}n.start({name:"drag"},t.interactable,e.children(".node-grabber")[0])}}),interact("#nodes .node-port-in").draggable({onstart:function(t){temp.show(),$(t.target).addClass("node-dragging")},onend:function(t){var n=$(t.target);if(temp.hide(),n.removeClass("node-dragging"),"undefined"==typeof t.dropzone){var e=n.data("linkId");"undefined"!=typeof e&&null!==e&&(Simulation.removeLink(e),updateState())}},onmove:function(t){positionTempLine(t.target,t.pageX,t.pageY)}}).dropzone({accept:".node-port-out",ondropactivate:function(t){var n=$(t.target);n.parent().hasClass("node-palette")||n.addClass("node-dropzone")},ondropdeactivate:function(t){var n=$(t.target);n.parent().hasClass("node-palette")||n.removeClass("node-dropzone")},ondrop:function(t){var n=$(t.target),e=$(t.relatedTarget);addLinkElem(n,e),updateState()}}),interact("#nodes .node-port-out").draggable({onstart:function(t){temp.show(),$(t.target).addClass("node-dragging")},onend:function(t){var n=$(t.target);if(temp.hide(),n.removeClass("node-dragging"),"undefined"==typeof t.dropzone){var e=n.data("linkId");"undefined"!=typeof e&&null!==e&&(Simulation.removeLink(e),updateState())}},onmove:function(t){positionTempLine(t.target,t.pageX,t.pageY)}}).dropzone({accept:".node-port-in",ondropactivate:function(t){var n=$(t.target);n.parent().hasClass("node-palette")||n.addClass("node-dropzone")},ondropdeactivate:function(t){var n=$(t.target);n.parent().hasClass("node-palette")||n.removeClass("node-dropzone")},ondrop:function(t){var n=$(t.relatedTarget),e=$(t.target);addLinkElem(n,e),updateState()}}),$(document).ready(function(){var t=$("#square");grid.height(Consts.GRID*Consts.HEIGHT+1),t.attr("width",Consts.GRID),t.attr("height",Consts.GRID),t.children().attr("d","M "+Consts.GRID+" 0 L 0 0 0 "+Consts.GRID),resizeHandler(),$(".icon-input-button").click(function(){var t=$(this).parent().parent();t.hasClass("node-palette")||!function(){var n=!t.hasClass("node-active"),e=Simulation.getNode(t.data("nodeInfo").nodeId);e.logic=function(){return n},updateState()}()});var n=0;setInterval(function(){$(".node-active .icon-output-fan-path").attr("transform","rotate("+n+" 30 30)"),n=(n+10)%360},20),initPalette("#palette-inputs",[{numInPorts:0,numOutPorts:1,logic:function(){return!1},icon:"#icon-input"}]),initPalette("#palette-gates",[{numInPorts:2,numOutPorts:1,logic:function(t){return t[0]&&t[1]},icon:"#icon-and"},{numInPorts:2,numOutPorts:1,logic:function(t){return t[0]||t[1]},icon:"#icon-or"},{numInPorts:1,numOutPorts:1,logic:function(t){return!t[0]},icon:"#icon-not"},{numInPorts:2,numOutPorts:1,logic:function(t){return!(t[0]&&t[1])},icon:"#icon-nand"},{numInPorts:2,numOutPorts:1,logic:function(t){return!(t[0]||t[1])},icon:"#icon-nor"}]),initPalette("#palette-passive",[{numInPorts:1,numOutPorts:3,logic:function(t){return t[0]},icon:"#icon-passive"}]),initPalette("#palette-outputs",[{numInPorts:1,numOutPorts:0,logic:function(t){return t[0]},icon:"#icon-output-lamp"},{numInPorts:1,numOutPorts:0,logic:function(t){return t[0]},icon:"#icon-output-fan"}])}),$(window).resize(resizeHandler),temp.offset(grid.offset());