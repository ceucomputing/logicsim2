"use strict";var Consts={GRID:20,HEIGHT:33,NODE:3,PALETTE:3},Simulation={nodes:[],links:[],addNode:function(t,n,e,o){for(var r=this.nodes.length,a=[],i=[],d=0;d<t;d++)a[d]={nodeId:r,portId:d,inPort:!0,linkId:null};for(var s=0;s<n;s++)i[s]={nodeId:r,portId:s,inPort:!1,linkId:null};return this.nodes[r]={nodeId:r,state:null,inPorts:a,outPorts:i,logic:e,elem:o},r},getNode:function(t){return this.nodes[t]},removeNode:function(t){var n=this.nodes[t],e=!0,o=!1,r=void 0;try{for(var a,i=n.inPorts[Symbol.iterator]();!(e=(a=i.next()).done);e=!0){var d=a.value;null!==d.linkId&&this.removeLink(d.linkId)}}catch(s){o=!0,r=s}finally{try{!e&&i["return"]&&i["return"]()}finally{if(o)throw r}}var l=!0,u=!1,f=void 0;try{for(var c,p=n.outPorts[Symbol.iterator]();!(l=(c=p.next()).done);l=!0){var v=c.value;null!==v.linkId&&this.removeLink(v.linkId)}}catch(s){u=!0,f=s}finally{try{!l&&p["return"]&&p["return"]()}finally{if(u)throw f}}delete this.nodes[t],$(n.elem).remove()},canLink:function(t,n,e,o){var r=[e],a=[],i=[],d=this.nodes[t].outPorts[n];null!==d&&i.push(d);var s=this.nodes[e].inPorts[o];for(null!==s&&i.push(s);r.length>0;){var l=this.nodes[r.pop()];if(l.nodeId===t)return!1;var u=!0,f=!1,c=void 0;try{for(var p,v=l.outPorts[Symbol.iterator]();!(u=(p=v.next()).done);u=!0){var y=p.value;if(null!==y.linkId&&i.indexOf(y.linkId)===-1){var h=this.links[y.linkId],m=this.nodes[h.inNodeId];a.indexOf(m.nodeId)===-1&&r.push(m.nodeId)}}}catch(I){f=!0,c=I}finally{try{!u&&v["return"]&&v["return"]()}finally{if(f)throw c}}a.push(l.nodeId)}return!0},addLink:function(t,n,e,o,r){var a=this.links.length;this.links[a]={linkId:a,state:null,outNodeId:t,outPortId:n,inNodeId:e,inPortId:o,elem:r};var i=this.nodes[t].outPorts[n];null!==i.linkId&&this.removeLink(i.linkId),i.linkId=a;var d=this.nodes[e].inPorts[o];return null!==d.linkId&&this.removeLink(d.linkId),d.linkId=a,a},getLink:function(t){return this.links[t]},removeLink:function(t){var n=this.links[t];this.nodes[n.outNodeId].outPorts[n.outPortId].linkId=null,this.nodes[n.inNodeId].inPorts[n.inPortId].linkId=null,delete this.links[t];var e=$(n.elem).data("linkInfo");e.inPortElem.removeData("linkId"),e.outPortElem.removeData("linkId"),$(n.elem).remove()},getNodeState:function(t){return this.nodes[t].state},getLinkState:function(t){return this.links[t].state},update:function(){var t=[],n=[],e=!0,o=!1,r=void 0;try{for(var a,i=this.nodes[Symbol.iterator]();!(e=(a=i.next()).done);e=!0){var d=a.value;"undefined"!=typeof d&&(d.state=null)}}catch(s){o=!0,r=s}finally{try{!e&&i["return"]&&i["return"]()}finally{if(o)throw r}}var l=!0,u=!1,f=void 0;try{for(var c,p=this.links[Symbol.iterator]();!(l=(c=p.next()).done);l=!0){var v=c.value;"undefined"!=typeof v&&(v.state=null)}}catch(s){u=!0,f=s}finally{try{!l&&p["return"]&&p["return"]()}finally{if(u)throw f}}var y=!0,h=!1,m=void 0;try{for(var I,g=this.nodes[Symbol.iterator]();!(y=(I=g.next()).done);y=!0){var x=I.value;"undefined"!=typeof x&&0===x.inPorts.length&&t.push(x.nodeId)}}catch(s){h=!0,m=s}finally{try{!y&&g["return"]&&g["return"]()}finally{if(h)throw m}}for(;t.length>0;){var P=this.nodes[t.pop()],k=[],C=!0,S=!1,E=void 0;try{for(var D,$=P.inPorts[Symbol.iterator]();!(C=(D=$.next()).done);C=!0){var O=D.value;k.push(this.links[O.linkId].state)}}catch(s){S=!0,E=s}finally{try{!C&&$["return"]&&$["return"]()}finally{if(S)throw E}}P.state=P.logic(k);var N=!0,b=!1,T=void 0;try{for(var G,L=P.outPorts[Symbol.iterator]();!(N=(G=L.next()).done);N=!0){var w=G.value;if(null!==w.linkId){var R=this.links[w.linkId];R.state=P.state;var F=this.nodes[R.inNodeId],H=!0,z=!0,X=!1,Y=void 0;try{for(var A,M=F.inPorts[Symbol.iterator]();!(z=(A=M.next()).done);z=!0){var q=A.value;if(null===q.linkId){H=!1;break}var j=this.links[q.linkId];if(null===j.state){H=!1;break}}}catch(s){X=!0,Y=s}finally{try{!z&&M["return"]&&M["return"]()}finally{if(X)throw Y}}H&&n.indexOf(F.nodeId)===-1&&t.push(F.nodeId)}}}catch(s){b=!0,T=s}finally{try{!N&&L["return"]&&L["return"]()}finally{if(b)throw T}}n.push(P.nodeId)}}},grid=$("#grid"),nodes=$("#nodes"),links=$("#links"),temp=$("#temp"),tempLine=$("#temp-line"),map=[[]],toGrid=function(t){var n=grid.offset();return{x:Math.round((t.x-n.left)/Consts.GRID),y:Math.round((t.y-n.top)/Consts.GRID)}},toPage=function(t){var n=grid.offset();return{x:n.left+t.x*Consts.GRID,y:n.top+t.y*Consts.GRID}},isFreeSpace=function(t){var n=t.x,e=t.y;if(n<1||e<1)return!1;if(n>map.length-Consts.NODE-1)return!1;if(e>Consts.HEIGHT-Consts.NODE-1)return!1;for(var o=-1;o<Consts.NODE+1;o++)for(var r=-1;r<Consts.NODE+1;r++)if(map[n+o][e+r])return!1;return!0},findFreeSpace=function(t){var n=t.x,e=t.y,o=Math.max(map.length,Consts.HEIGHT);if(isFreeSpace({x:n,y:e}))return{x:n,y:e};for(var r=1;r<o;r++){if(isFreeSpace({x:n-r,y:e}))return{x:n-r,y:e};if(isFreeSpace({x:n+r,y:e}))return{x:n+r,y:e};if(isFreeSpace({x:n,y:e-r}))return{x:n,y:e-r};if(isFreeSpace({x:n,y:e+r}))return{x:n,y:e+r};for(var a=1;a<=r-1;a++){if(isFreeSpace({x:n-a,y:e-r}))return{x:n-a,y:e-r};if(isFreeSpace({x:n-a,y:e+r}))return{x:n-a,y:e+r};if(isFreeSpace({x:n+a,y:e-r}))return{x:n+a,y:e-r};if(isFreeSpace({x:n+a,y:e+r}))return{x:n+a,y:e+r};if(isFreeSpace({x:n-r,y:e-a}))return{x:n-r,y:e-a};if(isFreeSpace({x:n+r,y:e-a}))return{x:n+r,y:e-a};if(isFreeSpace({x:n-r,y:e+a}))return{x:n-r,y:e+a};if(isFreeSpace({x:n+r,y:e+a}))return{x:n+r,y:e+a}}if(isFreeSpace({x:n-r,y:e-r}))return{x:n-r,y:e-r};if(isFreeSpace({x:n-r,y:e+r}))return{x:n-r,y:e+r};if(isFreeSpace({x:n+r,y:e-r}))return{x:n+r,y:e-r};if(isFreeSpace({x:n+r,y:e+r}))return{x:n+r,y:e+r}}return null},resizeHandler=function(){var t=map.length,n=Math.floor(grid.parent().width()/Consts.GRID);if(n!==t){map=new Array(n);for(var e=0;e<n;e++){map[e]=new Array(Consts.HEIGHT);for(var o=0;o<Consts.HEIGHT;o++)map[e][o]=!1}var r=[],a=!0,i=!1,d=void 0;try{for(var s,l=nodes.children()[Symbol.iterator]();!(a=(s=l.next()).done);a=!0){var u=s.value,f=$(u),c=f.data("nodeInfo"),p=findFreeSpace({x:c.gridX,y:c.gridY});if(null!==p){c.gridX=p.x,c.gridY=p.y,f.data("nodeInfo",c);var v=toPage(p);f.offset({left:v.x,top:v.y});for(var y=0;y<Consts.NODE;y++)for(var h=0;h<Consts.NODE;h++)map[p.x+y][p.y+h]=!0}else r.push(u)}}catch(m){i=!0,d=m}finally{try{!a&&l["return"]&&l["return"]()}finally{if(i)throw d}}var I=!0,g=!1,x=void 0;try{for(var P,k=r[Symbol.iterator]();!(I=(P=k.next()).done);I=!0){var C=P.value;removeNodeElem(C)}}catch(m){g=!0,x=m}finally{try{!I&&k["return"]&&k["return"]()}finally{if(g)throw x}}var S=n*Consts.GRID+1;grid.width(S),$(".link").width(S),temp.width(S),redrawLinks()}},initPalette=function(t,n){for(var e=$(t),o=$("#node-template").children().first(),r=null,a=0;a<n.length;a++){var i=n[a],d=$(document.createElement("td")),s=o.clone();switch(a%Consts.PALETTE===0&&(null!==r&&r.appendTo(e),r=$(document.createElement("tr"))),s.data("def",i),i.numInPorts){case 0:s.find(".node-port-in-1").hide(),s.find(".node-port-in-2").hide(),s.find(".node-port-in-3").hide();break;case 1:s.find(".node-port-in-1").hide(),s.find(".node-port-in-2").first().data("inPortId",0),s.find(".node-port-in-3").hide();break;case 2:s.find(".node-port-in-1").first().data("inPortId",0),s.find(".node-port-in-2").hide(),s.find(".node-port-in-3").first().data("inPortId",1);break;case 3:s.find(".node-port-in-1").first().data("inPortId",0),s.find(".node-port-in-2").first().data("inPortId",1),s.find(".node-port-in-3").first().data("inPortId",2)}switch(i.numOutPorts){case 0:s.find(".node-port-out-1").hide(),s.find(".node-port-out-2").hide(),s.find(".node-port-out-3").hide();break;case 1:s.find(".node-port-out-1").hide(),s.find(".node-port-out-2").first().data("outPortId",0),s.find(".node-port-out-3").hide();break;case 2:s.find(".node-port-out-1").first().data("outPortId",0),s.find(".node-port-out-2").hide(),s.find(".node-port-out-3").first().data("outPortId",1);break;case 3:s.find(".node-port-out-1").first().data("outPortId",0),s.find(".node-port-out-2").first().data("outPortId",1),s.find(".node-port-out-3").first().data("outPortId",2)}$(i.icon).children().clone(!0).appendTo(s.find(".node-grabber")),s.appendTo(d),d.appendTo(r)}if(null!==r){for(var l=0;l<Consts.PALETTE-n.length%Consts.PALETTE;l++)$(document.createElement("td")).appendTo(r);r.appendTo(e)}},removeNodeElem=function(t){var n=$(t).data("nodeInfo");"undefined"==typeof n?t.remove():Simulation.removeNode(n.nodeId)},getPortCoords=function(t){var n=t.parent(),e=n.data("def"),o=n.data("nodeInfo"),r={x:o.gridX,y:o.gridY};if(t.hasClass("node-port-in")){var a=t.data("inPortId");switch(a){case 0:r.y+=1==e.numInPorts?1:0;break;case 1:r.y+=2==e.numInPorts?2:1;break;case 2:r.y+=2}}else{var i=t.data("outPortId");switch(r.x+=2,i){case 0:r.y+=1==e.numOutPorts?1:0;break;case 1:r.y+=2==e.numOutPorts?2:1;break;case 2:r.y+=2}}return r},isOpen=function(t){return!(t.x<0||t.y<0)&&(!(t.x>map.length-1)&&(!(t.y>map[t.x].length-1)&&!map[t.x][t.y]))},toCoordsString=function(t){return String(t.x)+","+String(t.y)},equalCoords=function(t,n){return t.x===n.x&&t.y===n.y},addToPath=function(t,n,e,o,r,a){if(isOpen(t)){var i=toCoordsString(t),d=r+(a?1.5:1),s=n[i];"undefined"==typeof s?(s={coords:t,path:[t].concat(o),length:d},n[i]=s,e.push(s)):d<s.length&&(s.path=[t].concat(o),s.length=d)}},findPath=function(t,n){var e=function(t,n){return t.length-n.length},o={x:t.x-1,y:t.y},r=toCoordsString(o),a={x:n.x+1,y:n.y},i={},d=[],s={coords:o,path:[o],length:1};for(i[r]=s,d.push(s);Object.keys(d).length>0;){d.sort(e);var l=d.shift();if(equalCoords(l.coords,a))return[n].concat(l.path).concat([t]);addToPath({x:l.coords.x-1,y:l.coords.y},i,d,l.path,l.length,!1),addToPath({x:l.coords.x+1,y:l.coords.y},i,d,l.path,l.length,!1),addToPath({x:l.coords.x,y:l.coords.y-1},i,d,l.path,l.length,!1),addToPath({x:l.coords.x,y:l.coords.y+1},i,d,l.path,l.length,!1),addToPath({x:l.coords.x-1,y:l.coords.y-1},i,d,l.path,l.length,!0),addToPath({x:l.coords.x-1,y:l.coords.y+1},i,d,l.path,l.length,!0),addToPath({x:l.coords.x+1,y:l.coords.y-1},i,d,l.path,l.length,!0),addToPath({x:l.coords.x+1,y:l.coords.y+1},i,d,l.path,l.length,!0)}return null},toPoints=function(t){var n="",e=!0,o=!1,r=void 0;try{for(var a,i=t[Symbol.iterator]();!(e=(a=i.next()).done);e=!0){var d=a.value,s=d.x*Consts.GRID+Consts.GRID/2,l=d.y*Consts.GRID+Consts.GRID/2;n+=toCoordsString({x:s,y:l})+" "}}catch(u){o=!0,r=u}finally{try{!e&&i["return"]&&i["return"]()}finally{if(o)throw r}}return n.slice(0,-1)},addLinkElem=function(t,n){var e=t.data("inPortId"),o=t.parent().data("nodeInfo").nodeId,r=n.data("outPortId"),a=n.parent().data("nodeInfo").nodeId;if(Simulation.canLink(a,r,o,e)){var i=t.data("linkId");"undefined"!=typeof i&&Simulation.removeLink(i);var d=n.data("linkId");"undefined"!=typeof d&&Simulation.removeLink(d);var s=getPortCoords(t),l=getPortCoords(n),u=findPath(s,l),f=$("#link-template").children().first().clone();f.children().first().attr("points",toPoints(u)),f.appendTo(links),f.offset(grid.offset());var c=Simulation.addLink(a,r,o,e,f);f.data("linkInfo",{linkId:c,inPortElem:t,outPortElem:n}),t.data("linkId",c),n.data("linkId",c)}},redrawLinks=function(){var t=!0,n=!1,e=void 0;try{for(var o,r=links.children()[Symbol.iterator]();!(t=(o=r.next()).done);t=!0){var a=o.value,i=$(a).data("linkInfo"),d=findPath(getPortCoords(i.inPortElem),getPortCoords(i.outPortElem));$(a).children().first().attr("points",toPoints(d))}}catch(s){n=!0,e=s}finally{try{!t&&r["return"]&&r["return"]()}finally{if(n)throw e}}},updateState=function(){Simulation.update();var t=!0,n=!1,e=void 0;try{for(var o,r=nodes.children()[Symbol.iterator]();!(t=(o=r.next()).done);t=!0){var a=o.value,i=$(a),d=Simulation.getNodeState(i.data("nodeInfo").nodeId);null===d?(i.removeClass("node-active"),i.removeClass("node-inactive")):d?(i.addClass("node-active"),i.removeClass("node-inactive")):(i.removeClass("node-active"),i.addClass("node-inactive"))}}catch(s){n=!0,e=s}finally{try{!t&&r["return"]&&r["return"]()}finally{if(n)throw e}}var l=!0,u=!1,f=void 0;try{for(var c,p=links.children()[Symbol.iterator]();!(l=(c=p.next()).done);l=!0){var v=c.value,y=$(v),h=Simulation.getLinkState(y.data("linkInfo").linkId);null===h?(y.removeClass("link-active"),y.removeClass("link-inactive")):h?(y.addClass("link-active"),y.removeClass("link-inactive")):(y.removeClass("link-active"),y.addClass("link-inactive"))}}catch(s){u=!0,f=s}finally{try{!l&&p["return"]&&p["return"]()}finally{if(u)throw f}}},positionTempLine=function(t,n,e){var o=grid.offset(),r=toPage(getPortCoords($(t)));tempLine.attr("x1",r.x+Consts.GRID/2-o.left),tempLine.attr("y1",r.y+Consts.GRID/2-o.top),tempLine.attr("x2",n-o.left),tempLine.attr("y2",e-o.top)};interact(".node-grabber").draggable({manualStart:!0,snap:{targets:[function(t,n){var e=toPage(toGrid({x:t-Consts.NODE/2*Consts.GRID,y:n-Consts.NODE/2*Consts.GRID}));return e.x+=Consts.NODE/2*Consts.GRID,e.y+=Consts.NODE/2*Consts.GRID,e}]},onmove:function(t){var n=$(t.target).parent();n.offset({left:t.pageX-Consts.NODE/2*Consts.GRID,top:t.pageY-Consts.NODE/2*Consts.GRID})},onstart:function(t){var n=$(t.target).parent(),e=n.data("nodeInfo");if("undefined"!=typeof e)for(var o=0;o<Consts.NODE;o++)for(var r=0;r<Consts.NODE;r++)map[e.gridX+o][e.gridY+r]=!1},onend:function(t){var n=$(t.target).parent(),e=toGrid({x:t.pageX-Consts.NODE/2*Consts.GRID,y:t.pageY-Consts.NODE/2*Consts.GRID}),o=e.x,r=e.y;if(o<-Consts.NODE||r<-Consts.NODE||o>map.length+Consts.NODE||r>Consts.HEIGHT+Consts.NODE)return removeNodeElem(n),void updateState();var a=findFreeSpace({x:o,y:r});if(null===a)return removeNodeElem(n),void updateState();o=a.x,r=a.y;var i=toPage(a);n.offset({left:i.x,top:i.y});var d=n.data("nodeInfo");if("undefined"==typeof d){var s=n.data("def"),l=Simulation.addNode(s.numInPorts,s.numOutPorts,s.logic,n);d={nodeId:l}}d.gridX=o,d.gridY=r,n.data("nodeInfo",d);for(var u=0;u<Consts.NODE;u++)for(var f=0;f<Consts.NODE;f++)map[o+u][r+f]=!0;redrawLinks(),updateState()}}).on("move",function(t){var n=t.interaction;if(n.pointerIsDown&&!n.interacting()){var e=$(t.currentTarget).parent();if(e.hasClass("node-palette")){var o=e.clone(!0);o.removeClass("node-palette"),o.appendTo("#nodes"),o.offset($(t.currentTarget).parent().offset()),e=o}n.start({name:"drag"},t.interactable,e.children(".node-grabber")[0])}}),interact("#nodes .node-port-in").draggable({onstart:function(t){temp.show(),$(t.target).addClass("node-dragging")},onend:function(t){var n=$(t.target);if(temp.hide(),n.removeClass("node-dragging"),"undefined"==typeof t.dropzone){var e=n.data("linkId");"undefined"!=typeof e&&null!==e&&(Simulation.removeLink(e),updateState())}},onmove:function(t){positionTempLine(t.target,t.pageX,t.pageY)}}).dropzone({accept:".node-port-out",ondropactivate:function(t){var n=$(t.target);n.parent().hasClass("node-palette")||n.addClass("node-dropzone")},ondropdeactivate:function(t){var n=$(t.target);n.parent().hasClass("node-palette")||n.removeClass("node-dropzone")},ondrop:function(t){var n=$(t.target),e=$(t.relatedTarget);addLinkElem(n,e),updateState()}}),interact("#nodes .node-port-out").draggable({onstart:function(t){temp.show(),$(t.target).addClass("node-dragging")},onend:function(t){var n=$(t.target);if(temp.hide(),n.removeClass("node-dragging"),"undefined"==typeof t.dropzone){var e=n.data("linkId");"undefined"!=typeof e&&null!==e&&(Simulation.removeLink(e),updateState())}},onmove:function(t){positionTempLine(t.target,t.pageX,t.pageY)}}).dropzone({accept:".node-port-in",ondropactivate:function(t){var n=$(t.target);n.parent().hasClass("node-palette")||n.addClass("node-dropzone")},ondropdeactivate:function(t){var n=$(t.target);n.parent().hasClass("node-palette")||n.removeClass("node-dropzone")},ondrop:function(t){var n=$(t.relatedTarget),e=$(t.target);addLinkElem(n,e),updateState()}}),$(document).ready(function(){var t=$("#square");grid.height(Consts.GRID*Consts.HEIGHT+1),t.attr("width",Consts.GRID),t.attr("height",Consts.GRID),t.children().attr("d","M "+Consts.GRID+" 0 L 0 0 0 "+Consts.GRID),temp.offset(grid.offset()),resizeHandler(),$(".icon-input-button").click(function(){var t=$(this).parent().parent();t.hasClass("node-palette")||!function(){var n=!t.hasClass("node-active"),e=Simulation.getNode(t.data("nodeInfo").nodeId);e.logic=function(){return n},updateState()}()}),initPalette("#palette-inputs",[{numInPorts:0,numOutPorts:1,logic:function(){return!1},icon:"#icon-input"}]),initPalette("#palette-gates",[{numInPorts:2,numOutPorts:1,logic:function(t){return t[0]&&t[1]},icon:"#icon-and"},{numInPorts:2,numOutPorts:1,logic:function(t){return t[0]||t[1]},icon:"#icon-or"},{numInPorts:1,numOutPorts:1,logic:function(t){return!t[0]},icon:"#icon-not"},{numInPorts:2,numOutPorts:1,logic:function(t){return!(t[0]&&t[1])},icon:"#icon-nand"},{numInPorts:2,numOutPorts:1,logic:function(t){return!(t[0]||t[1])},icon:"#icon-nor"}]),initPalette("#palette-passive",[{numInPorts:1,numOutPorts:3,logic:function(t){return t[0]},icon:"#icon-passive"}]),initPalette("#palette-outputs",[{numInPorts:1,numOutPorts:0,logic:function(t){return t[0]},icon:"#icon-output-lamp"},{numInPorts:1,numOutPorts:0,logic:function(t){return t[0]},icon:"#icon-output-fan"}])}),$(window).resize(resizeHandler);